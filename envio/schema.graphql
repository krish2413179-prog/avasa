# ========================================
# üèÜ PropChain AI - Award-Winning DeFi Analytics Schema
# Real-time indexing for RWA properties + Advanced Payment Automation
# ========================================

# ========================================
# üí∞ PAYMENT AUTOMATION ENTITIES
# ========================================

# Recurring Payment Schedules
type PaymentSchedule @entity {
  id: ID! # scheduleId
  payer: String!
  recipient: String!
  amount: BigInt!
  interval: BigInt!
  maxExecutions: BigInt!
  executionsLeft: BigInt!
  executorReward: BigInt!
  isActive: Boolean!
  createdAt: BigInt!
  nextPayment: BigInt!
  contractAddress: String!
  
  # Relations
  executions: [PaymentExecution!]! @derivedFrom(field: "schedule")
  permissions: [PaymentPermission!]! @derivedFrom(field: "user")
}

# Individual Payment Executions
type PaymentExecution @entity {
  id: ID! # txHash_logIndex
  schedule: PaymentSchedule!
  payer: String!
  recipient: String!
  amount: BigInt!
  executor: String!
  executorReward: BigInt!
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: String!
  gasUsed: BigInt!
  gasPrice: BigInt!
}

# Payment Permissions (EIP-7715 style)
type PaymentPermission @entity {
  id: ID! # user_contract
  user: String!
  contractAddress: String!
  maxAmountPerPayment: BigInt!
  maxTotalAmount: BigInt!
  totalSpent: BigInt!
  validUntil: BigInt!
  isActive: Boolean!
  grantedAt: BigInt!
  
  # Relations
  schedules: [PaymentSchedule!]! @derivedFrom(field: "payer")
}

# ========================================
# üîÑ SWAP POOL ENTITIES
# ========================================

# Swap Pool Schedules (Recurring Swaps)
type SwapSchedule @entity {
  id: ID! # scheduleId
  user: String!
  usdcAmount: BigInt!
  interval: BigInt!
  maxExecutions: BigInt!
  executionsLeft: BigInt!
  executorReward: BigInt!
  isActive: Boolean!
  createdAt: BigInt!
  nextSwap: BigInt!
  
  # Relations
  executions: [SwapExecution!]! @derivedFrom(field: "schedule")
}

# Individual Swap Executions
type SwapExecution @entity {
  id: ID! # txHash_logIndex
  schedule: SwapSchedule
  user: String!
  usdcAmount: BigInt!
  ethAmount: BigInt!
  executor: String!
  executorReward: BigInt!
  swapType: String! # "instant" or "recurring"
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: String!
  gasUsed: BigInt!
  gasPrice: BigInt!
}

# Liquidity Pool Events
type LiquidityEvent @entity {
  id: ID! # txHash_logIndex
  eventType: String! # "add" or "remove"
  ethAmount: BigInt!
  usdcAmount: BigInt!
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: String!
}

# Swap Pool Permissions
type SwapPermission @entity {
  id: ID! # user_contract
  user: String!
  maxAmountPerSwap: BigInt!
  maxTotalAmount: BigInt!
  totalSpent: BigInt!
  validUntil: BigInt!
  isActive: Boolean!
  grantedAt: BigInt!
}

# ========================================
# üè¢ RWA PROPERTY ENTITIES
# ========================================

# Property Transactions (Purchases/Withdrawals)
type PropertyTransaction @entity {
  id: ID! # txHash_logIndex
  propertyId: String!
  propertyName: String!
  propertyAddress: String!
  investor: String!
  shares: BigInt
  amount: BigInt!
  cost: BigInt
  action: String! # "purchase", "withdraw", "yield_claim"
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: String!
}

# Yield Distribution Events
type YieldTransaction @entity {
  id: ID! # txHash_logIndex
  propertyId: String!
  propertyName: String!
  propertyAddress: String!
  investor: String!
  amount: BigInt!
  action: String! # "yield_claim"
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: String!
}

# Property Share Transfers
type TransferTransaction @entity {
  id: ID! # txHash_logIndex
  propertyId: String!
  propertyName: String!
  propertyAddress: String!
  from: String!
  to: String!
  value: BigInt!
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: String!
}

# Property Updates (Price changes, etc.)
type PropertyUpdate @entity {
  id: ID! # txHash_logIndex
  propertyId: String!
  propertyName: String!
  pricePerShare: BigInt!
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: String!
}

# User Portfolio Aggregation
type UserPortfolio @entity {
  id: ID! # user_propertyId
  user: String!
  propertyId: String!
  totalShares: BigInt!
  totalInvested: BigInt!
  totalYieldClaimed: BigInt!
  lastUpdated: BigInt!
  
  # Relations
  transactions: [PropertyTransaction!]! @derivedFrom(field: "investor")
  yields: [YieldTransaction!]! @derivedFrom(field: "investor")
}

# ========================================
# üíé TOKEN TRACKING ENTITIES
# ========================================

# USDC Transfer Events
type USDCTransfer @entity {
  id: ID! # txHash_logIndex
  from: String!
  to: String!
  value: BigInt!
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: String!
  
  # Context detection
  isPaymentRelated: Boolean!
  isSwapRelated: Boolean!
  isPropertyRelated: Boolean!
  relatedContract: String
}

# USDC Approval Events
type USDCApproval @entity {
  id: ID! # txHash_logIndex
  owner: String!
  spender: String!
  value: BigInt!
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: String!
}

# ========================================
# üéØ EXECUTOR ANALYTICS ENTITIES
# ========================================

# Executor Performance Tracking
type ExecutorStats @entity {
  id: ID! # executor_address
  executor: String!
  totalExecutions: BigInt!
  totalRewardsEarned: BigInt!
  paymentExecutions: BigInt!
  swapExecutions: BigInt!
  averageReward: BigInt!
  firstExecution: BigInt!
  lastExecution: BigInt!
  
  # Relations
  paymentExecutions_rel: [PaymentExecution!]! @derivedFrom(field: "executor")
  swapExecutions_rel: [SwapExecution!]! @derivedFrom(field: "executor")
}

# Daily Executor Rewards
type DailyExecutorReward @entity {
  id: ID! # executor_date
  executor: String!
  date: String! # YYYY-MM-DD
  totalRewards: BigInt!
  executionCount: BigInt!
  paymentRewards: BigInt!
  swapRewards: BigInt!
}

# ========================================
# üìä ANALYTICS & AGGREGATION ENTITIES
# ========================================

# Daily Protocol Stats
type DailyProtocolStats @entity {
  id: ID! # date (YYYY-MM-DD)
  date: String!
  
  # Payment Stats
  totalPayments: BigInt!
  totalPaymentVolume: BigInt!
  activePaymentSchedules: BigInt!
  newPaymentSchedules: BigInt!
  
  # Swap Stats
  totalSwaps: BigInt!
  totalSwapVolumeUSDC: BigInt!
  totalSwapVolumeETH: BigInt!
  activeSwapSchedules: BigInt!
  newSwapSchedules: BigInt!
  
  # Property Stats
  totalPropertyInvestments: BigInt!
  totalPropertyVolume: BigInt!
  totalYieldDistributed: BigInt!
  
  # Executor Stats
  totalExecutorRewards: BigInt!
  activeExecutors: BigInt!
  
  # Gas Stats
  totalGasUsed: BigInt!
  averageGasPrice: BigInt!
}

# User Activity Summary
type UserActivity @entity {
  id: ID! # user_address
  user: String!
  
  # Payment Activity
  totalPaymentsSent: BigInt!
  totalPaymentsReceived: BigInt!
  totalPaymentVolumeSent: BigInt!
  totalPaymentVolumeReceived: BigInt!
  activePaymentSchedules: BigInt!
  
  # Swap Activity
  totalSwaps: BigInt!
  totalSwapVolumeUSDC: BigInt!
  totalSwapVolumeETH: BigInt!
  activeSwapSchedules: BigInt!
  
  # Property Activity
  totalPropertyInvestments: BigInt!
  totalPropertyVolume: BigInt!
  totalYieldClaimed: BigInt!
  propertiesOwned: [String!]!
  
  # Executor Activity
  totalExecutions: BigInt!
  totalExecutorRewards: BigInt!
  
  # Timestamps
  firstActivity: BigInt!
  lastActivity: BigInt!
}

# Contract Interaction Summary
type ContractInteraction @entity {
  id: ID! # contract_address
  contractAddress: String!
  contractName: String!
  totalTransactions: BigInt!
  totalVolume: BigInt!
  uniqueUsers: BigInt!
  firstInteraction: BigInt!
  lastInteraction: BigInt!
}

# ========================================
# üîÆ FUTURE DEFI ENTITIES (READY TO ENABLE)
# ========================================

# Uniswap V3 Swaps (commented out for now)
# type SwapTransaction @entity {
#   id: ID!
#   sender: String!
#   recipient: String!
#   amount0: BigInt!
#   amount1: BigInt!
#   sqrtPriceX96: BigInt!
#   liquidity: BigInt!
#   tick: Int!
#   timestamp: BigInt!
#   blockNumber: BigInt!
#   transactionHash: String!
# }

# Superfluid Streams (commented out for now)
# type StreamTransaction @entity {
#   id: ID!
#   token: String!
#   sender: String!
#   receiver: String!
#   flowRate: BigInt!
#   totalSenderFlowRate: BigInt!
#   totalReceiverFlowRate: BigInt!
#   timestamp: BigInt!
#   blockNumber: BigInt!
#   transactionHash: String!
# }

# Aave V3 Lending (commented out for now)
# type LendingTransaction @entity {
#   id: ID!
#   reserve: String!
#   user: String!
#   onBehalfOf: String!
#   repayer: String!
#   amount: BigInt!
#   interestRateMode: Int!
#   borrowRate: BigInt!
#   referralCode: Int!
#   useATokens: Boolean!
#   action: String! # "supply", "borrow", "repay"
#   timestamp: BigInt!
#   blockNumber: BigInt!
#   transactionHash: String!
# }